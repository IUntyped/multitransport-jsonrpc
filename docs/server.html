<!DOCTYPE html>  <html> <head>   <title>server.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="client.html">                 client.js               </a>                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="server.html">                 server.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>The Agrosica JSON-RPC Server</h1>

<p>Designed to work in <em>Node.js</em>. There are a few Node.js JSON-RPC servers on
<a href="http://www.github.com">GitHub</a> already, but all required a fairly extensive
set of modifications to the RPC methods so they didn't look <em>natural</em>, and
therefore reusable internally, if desired, while this server makes that its
primary design goal. This JSON-RPC client is currently JSON-RPC 1.0 compliant.
Will add 2.0 compatibility if this is determined to be important.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>The JSONRPC constructor</h2>

<p>Each JSON-RPC object is tied to a <em>scope</em>, an object containing functions to
call. If not passed an explicit scope, <em>Node.js</em>' <em>root</em> scope will be used.
Also, unlike the Javascript running in web browsers, functions not explicitly
assigned to a scope are attached to the anonymous scope block only and cannot
be accessed even from the <em>root</em> scope.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">JSONRPC</span><span class="p">(</span><span class="nx">transport</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="nx">transport</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">scope</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The actual object initialization occurs here. If the <em>scope</em> is not
defined, the <em>root</em> scope is used, and then the object is returned to
the developer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">scope</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">scope</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">scope</span> <span class="o">=</span> <span class="nx">root</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>The <em>rpc.methodList</em> method</h3>

<p>is a JSON-RPC extension that returns a list of all methods in the scope</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">scope</span><span class="p">[</span><span class="s1">&#39;rpc.methodList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">methods</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">methods</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">methods</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleJSON</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>The <em>handleJSON</em> function</h3>

<p>makes up the majority of the JSON-RPC server logic, handling the requests
from clients, passing the call to the correct function, catching any
errors the function may throw, and calling the function to return the
results back to the client.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handleJSON</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">handleJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>If the method is defined in the scope and is not marked as a
blocking function, then a callback must be defined for
the function. The callback takes two parameters: the
<em>result</em> of the function, and an <em>error</em> message.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">arglen</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">?</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">arglen</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">blocking</span><span class="p">))</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">outObj</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">outObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">outObj</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="nx">outObj</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">message</span><span class="p">};</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">outObj</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="nx">outObj</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">outObj</span><span class="p">);</span>
                <span class="p">};</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">next</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="nx">next</span><span class="p">];</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This <em>try-catch</em> block seems pointless, since it is
not possible to <em>catch</em> an error further into a
<em>CPS</em> stack, but if the (normally short) blocking
portion of the call throws an error, this will
prevent the <em>Node.js</em> server from crashing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">outErr</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="nx">outErr</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">outObj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">result</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">outErr</span> <span class="p">};</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="nx">outObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">outObj</span><span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>A blocking function will <em>return</em> a value immediately or
<em>throw</em> an error, so this portion consists only of a
<em>try-catch</em> block, but is otherwise identical to the
above nonblocking code.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">blocking</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="p">}</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">outObj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">result</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">),</span> <span class="nx">error</span><span class="o">:</span> <span class="kc">null</span> <span class="p">};</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="nx">outObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">outObj</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">outErr</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">};</span>
                    <span class="kd">var</span> <span class="nx">outObj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">result</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">outErr</span> <span class="p">};</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="nx">outObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">outObj</span><span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If the interpretation of the POSTed data fails at any
point, be sure to return a meaningful error message.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">({</span><span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span><span class="p">{</span><span class="nx">message</span><span class="o">:</span><span class="s2">&quot;Requested method does not exist.&quot;</span><span class="p">},</span> <span class="nx">id</span><span class="o">:-</span><span class="mi">1</span><span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">({</span><span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span><span class="p">{</span><span class="nx">message</span><span class="o">:</span><span class="s2">&quot;Did not receive valid JSON-RPC data.&quot;</span><span class="p">},</span> <span class="nx">id</span><span class="o">:-</span><span class="mi">1</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">({</span><span class="nx">result</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span><span class="p">{</span><span class="nx">message</span><span class="o">:</span><span class="s2">&quot;Did not receive valid JSON-RPC data.&quot;</span><span class="p">},</span> <span class="nx">id</span><span class="o">:-</span><span class="mi">1</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>The <em>register</em> function</h3>

<p>allows one to attach a function to the current scope after the scope has
been attached to the JSON-RPC server, for similar possible shenanigans as
described above. This method in particular, though, by attaching new
functions to the current scope, could be used for caching purposes or
self-modifying code that rewrites its own definition.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">methodName</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">scope</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Make a <code>blocking</code> helper method to identify blocking methods as blocking (if the heuristic fails)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">blocking</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">blocking</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">func</span><span class="p">.</span><span class="nx">blocking</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">func</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Cleanly shut down the JSONRPC server</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">shutdown</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Export the server constructor</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">JSONRPC</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 